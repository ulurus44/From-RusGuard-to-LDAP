import pyodbc
from ldap3 import Server, Connection, ALL
import secrets, string
import logging
from datetime import datetime
import requests
import time
import sys
import os

# === –ó–ê–ì–†–£–ó–ö–ê –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–ò ===
try:
    from config import (
        TELEGRAM_TOKEN,
        TELEGRAM_CHAT_ID,
        SQL_SERVER,
        SQL_DATABASE,
        LDAP_SERVER,
        LDAP_BIND_DN,
        LDAP_BIND_PASS,
        BASE_DN,
        WIFI_NETWORK_NAME,
        LOG_FILE_PATH,
        SYNC_INTERVAL_SECONDS
    )
except ImportError:
    print("‚ùå –û—à–∏–±–∫–∞: —Ñ–∞–π–ª config.py –Ω–µ –Ω–∞–π–¥–µ–Ω!")
    print("üìù –°–∫–æ–ø–∏—Ä—É–π—Ç–µ config.example.py –≤ config.py –∏ –∑–∞–ø–æ–ª–Ω–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ")
    sys.exit(1)


def send_telegram(login, full_name, emp_id, password):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç –ø–∞—Ä–æ–ª—å –≤ Telegram –≥—Ä—É–ø–ø—É"""
    bot_msg = f"""
üÜï Wi-Fi —É—á—ë—Ç–∫–∞ —Å–æ–∑–¥–∞–Ω–∞!

üë§ **{full_name}**
üÜî RusGuard ID: `{emp_id}`
üîë **–õ–æ–≥–∏–Ω:** `{login}`
üîë **–ü–∞—Ä–æ–ª—å:** `{password}`

üåê –°–µ—Ç—å: {WIFI_NETWORK_NAME}  
üì∂ –ì–æ—Ç–æ–≤ –∫ –∏—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∏—é!
    """
    
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    data = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': bot_msg,
        'parse_mode': 'Markdown'
    }
    
    try:
        response = requests.post(url, data=data, timeout=10)
        if response.status_code == 200:
            logging.info(f"Telegram OK: {login}")
            print(f"üì± Telegram –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω: {login}")
            return True
        else:
            logging.error(f"Telegram failed {login}: {response.text}")
            print(f"üì± Telegram –æ—à–∏–±–∫–∞ {login}: {response.status_code}")
            return False
    except Exception as e:
        logging.error(f"Telegram error {login}: {e}")
        print(f"üì± Telegram –æ—à–∏–±–∫–∞ {login}: {e}")
        return False


def send_telegram_deleted(login, full_name, emp_id, reason):
    """–û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ –æ–± —É–¥–∞–ª–µ–Ω–∏–∏ —É—á—ë—Ç–∫–∏"""
    bot_msg = f"""
üóëÔ∏è Wi-Fi —É—á—ë—Ç–∫–∞ —É–¥–∞–ª–µ–Ω–∞!

üë§ **{full_name}**
üÜî RusGuard ID: `{emp_id}`
üîë **–õ–æ–≥–∏–Ω:** `{login}`

‚ö†Ô∏è –ü—Ä–∏—á–∏–Ω–∞: {reason}
üö´ –î–æ—Å—Ç—É–ø –∫ {WIFI_NETWORK_NAME} –æ—Ç–∫–ª—é—á—ë–Ω
    """
    
    url = f"https://api.telegram.org/bot{TELEGRAM_TOKEN}/sendMessage"
    data = {
        'chat_id': TELEGRAM_CHAT_ID,
        'text': bot_msg,
        'parse_mode': 'Markdown'
    }
    
    try:
        response = requests.post(url, data=data, timeout=10)
        if response.status_code == 200:
            logging.info(f"Telegram DELETE OK: {login}")
            return True
        else:
            logging.error(f"Telegram DELETE failed {login}: {response.text}")
            return False
    except Exception as e:
        logging.error(f"Telegram DELETE error {login}: {e}")
        return False


def gen_password(length=6):
    alphabet = string.ascii_letters + string.digits
    return ''.join(secrets.choice(alphabet) for _ in range(length))


def cyrillic_to_latin(text):
    """–†—É—Å—Å–∫–∏–µ —Ñ–∞–º–∏–ª–∏–∏ ‚Üí —Ç—Ä–∞–Ω—Å–ª–∏—Ç"""
    mapping = {
        '–∞': 'a', '–±': 'b', '–≤': 'v', '–≥': 'g', '–¥': 'd', '–µ': 'e', '—ë': 'yo', '–∂': 'zh',
        '–∑': 'z', '–∏': 'i', '–π': 'y', '–∫': 'k', '–ª': 'l', '–º': 'm', '–Ω': 'n', '–æ': 'o',
        '–ø': 'p', '—Ä': 'r', '—Å': 's', '—Ç': 't', '—É': 'u', '—Ñ': 'f', '—Ö': 'h', '—Ü': 'ts',
        '—á': 'ch', '—à': 'sh', '—â': 'sch', '—ä': '', '—ã': 'y', '—å': '', '—ç': 'e', '—é': 'yu', '—è': 'ya',
        '–ê': 'A', '–ë': 'B', '–í': 'V', '–ì': 'G', '–î': 'D', '–ï': 'E', '–Å': 'Yo', '–ñ': 'Zh',
        '–ó': 'Z', '–ò': 'I', '–ô': 'Y', '–ö': 'K', '–õ': 'L', '–ú': 'M', '–ù': 'N', '–û': 'O',
        '–ü': 'P', '–†': 'R', '–°': 'S', '–¢': 'T', '–£': 'U', '–§': 'F', '–•': 'H', '–¶': 'Ts',
        '–ß': 'Ch', '–®': 'Sh', '–©': 'Sch', '–™': '', '–´': 'Y', '–¨': '', '–≠': 'E', '–Æ': 'Yu', '–Ø': 'Ya'
    }
    result = ''
    for char in text:
        result += mapping.get(char, char)
    return result


def do_sync():
    """–û—Å–Ω–æ–≤–Ω–∞—è —Ñ—É–Ω–∫—Ü–∏—è —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏"""
    
    # === –ö–û–ù–§–ò–ì ===
    SQL_CONN_STR = (
        f"DRIVER={{ODBC Driver 17 for SQL Server}};"
        f"SERVER={SQL_SERVER};"
        f"DATABASE={SQL_DATABASE};"
        f"Trusted_Connection=yes;"
    )
    
    # === SQL ===
    try:
        print("üìä SQL: –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...")
        cnxn = pyodbc.connect(SQL_CONN_STR)
        cursor = cnxn.cursor()
        print("‚úÖ SQL: OK")
    except Exception as e:
        print(f"‚ùå SQL –æ—à–∏–±–∫–∞: {e}")
        logging.error(f"SQL connection failed: {e}")
        return False

    # === LDAP ===
    try:
        print("üîó LDAP: –ø–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...")
        server = Server(LDAP_SERVER, get_info=ALL)
        ldap_conn = Connection(server, LDAP_BIND_DN, LDAP_BIND_PASS, auto_bind=True)
        print("‚úÖ LDAP: OK")
    except Exception as e:
        print(f"‚ùå LDAP –æ—à–∏–±–∫–∞: {e}")
        logging.error(f"LDAP connection failed: {e}")
        cnxn.close()
        return False

    # === –ß–ò–¢–ê–ï–ú –ê–ö–¢–ò–í–ù–´–• –°–û–¢–†–£–î–ù–ò–ö–û–í ===
    try:
        print("üë• SQL: —á–∏—Ç–∞–µ–º –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤...")
        cursor.execute("""
            SELECT 
                LastName AS Login,
                CONCAT(LastName, ' ', FirstName, ' ', SecondName) AS FullName,
                IntId
            FROM Employee 
            WHERE IsRemoved = 0 
              AND LastName IS NOT NULL
              AND IsLocked = 0
            ORDER BY IntId
        """)
        active_users = cursor.fetchall()
        print(f"üìà –ù–∞–π–¥–µ–Ω–æ {len(active_users)} –∞–∫—Ç–∏–≤–Ω—ã—Ö —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤ (–Ω–µ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–Ω—ã—Ö)")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è —Å–æ—Ç—Ä—É–¥–Ω–∏–∫–æ–≤: {e}")
        logging.error(f"Error reading employees: {e}")
        ldap_conn.unbind()
        cnxn.close()
        return False

    # === –°–û–ó–î–ê–Å–ú –ú–ù–û–ñ–ï–°–¢–í–û –ê–ö–¢–ò–í–ù–´–• –õ–û–ì–ò–ù–û–í ===
    active_logins = set()
    for row in active_users:
        login = cyrillic_to_latin(row.Login.strip())
        if login:
            active_logins.add(login.lower())

    # === –ß–ò–¢–ê–ï–ú –í–°–ï –£–ß–Å–¢–ö–ò –ò–ó LDAP ===
    try:
        print("üîç LDAP: —á–∏—Ç–∞–µ–º —Å—É—â–µ—Å—Ç–≤—É—é—â–∏–µ —É—á—ë—Ç–∫–∏...")
        ldap_conn.search(
            BASE_DN, 
            '(objectClass=inetOrgPerson)', 
            attributes=['uid', 'cn', 'employeeNumber']
        )
        ldap_users = ldap_conn.entries
        print(f"üìä –í LDAP –Ω–∞–π–¥–µ–Ω–æ {len(ldap_users)} —É—á—ë—Ç–æ–∫")
    except Exception as e:
        print(f"‚ùå –û—à–∏–±–∫–∞ —á—Ç–µ–Ω–∏—è LDAP: {e}")
        logging.error(f"LDAP search error: {e}")
        ldap_conn.unbind()
        cnxn.close()
        return False

    # === –°–¢–ê–¢–ò–°–¢–ò–ö–ê ===
    created = 0
    telegram_sent = 0
    updated = 0
    deleted = 0
    telegram_deleted_sent = 0
    errors = 0

    # === –§–ê–ó–ê 1: –£–î–ê–õ–ï–ù–ò–ï –ù–ï–ê–ö–¢–ò–í–ù–´–• ===
    print("\nüóëÔ∏è  –§–ê–ó–ê 1: –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö —É—á—ë—Ç–æ–∫...\n")
    
    for ldap_entry in ldap_users:
        ldap_login = str(ldap_entry.uid).lower()
        
        # –ï—Å–ª–∏ –ª–æ–≥–∏–Ω–∞ –ù–ï–¢ –≤ –∞–∫—Ç–∏–≤–Ω—ã—Ö ‚Äî —É–¥–∞–ª—è–µ–º
        if ldap_login not in active_logins:
            try:
                emp_num = str(ldap_entry.employeeNumber) if ldap_entry.employeeNumber else 'N/A'
                full_name = str(ldap_entry.cn) if ldap_entry.cn else ldap_login
                
                print(f"üóëÔ∏è  –£–¥–∞–ª—è–µ–º: {ldap_login} (ID:{emp_num})", end=" ... ")
                
                if ldap_conn.delete(ldap_entry.entry_dn):
                    logging.info(f"DELETED: {ldap_login} (ID:{emp_num})")
                    print(f"‚úÖ —É–¥–∞–ª—ë–Ω")
                    
                    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –≤ Telegram
                    if send_telegram_deleted(ldap_login, full_name, emp_num, "–ü—Ä–æ–ø—É—Å–∫ –∑–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω/—É–¥–∞–ª—ë–Ω"):
                        telegram_deleted_sent += 1
                    
                    deleted += 1
                else:
                    logging.error(f"Failed to delete {ldap_login}: {ldap_conn.result}")
                    print(f"‚ùå –æ—à–∏–±–∫–∞ —É–¥–∞–ª–µ–Ω–∏—è")
                    errors += 1
                    
            except Exception as e:
                logging.error(f"Error deleting {ldap_login}: {e}")
                print(f"‚ùå {str(e)[:50]}")
                errors += 1

    # === –§–ê–ó–ê 2: –°–û–ó–î–ê–ù–ò–ï –ù–û–í–´–• ===
    print("\n‚ú® –§–ê–ó–ê 2: –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤—ã—Ö —É—á—ë—Ç–æ–∫...\n")

    for idx, row in enumerate(active_users, 1):
        login = cyrillic_to_latin(row.Login.strip())
        full_name = row.FullName.strip()
        emp_id = row.IntId
        
        if not login:
            continue
        
        print(f"[{idx}/{len(active_users)}] {login}", end=" ... ")
        
        # –ü–æ–∏—Å–∫ –≤ LDAP
        try:
            ldap_conn.search(BASE_DN, f"(uid={login})", attributes=['uid'])
        except Exception as e:
            print(f"‚ùå –æ—à–∏–±–∫–∞ –ø–æ–∏—Å–∫–∞: {str(e)[:40]}")
            logging.error(f"LDAP search error for {login}: {e}")
            errors += 1
            continue
        
        if not ldap_conn.entries:
            # –°–û–ó–î–ê–Å–ú
            try:
                password = gen_password()
                
                dn = f"uid={login},{BASE_DN}"
                attrs = {
                    'objectClass': ['inetOrgPerson', 'organizationalPerson', 'person', 'top'],
                    'uid': login,
                    'cn': full_name or login,
                    'sn': login,
                    'employeeNumber': str(emp_id),
                    'userPassword': password,
                    'description': f'WiFi user from RusGuard ID:{emp_id}'
                }
                
                if ldap_conn.add(dn, attributes=attrs):
                    msg = f"CREATED: {login} (ID:{emp_id}) pwd:{password}"
                    logging.info(msg)
                    print(f"‚úÖ —Å–æ–∑–¥–∞–Ω | pwd: {password}")
                    
                    # –û–¢–ü–†–ê–í–õ–Ø–ï–ú –í TELEGRAM
                    if send_telegram(login, full_name, emp_id, password):   
                        telegram_sent += 1
                    else:
                        print(f"  ‚ö†Ô∏è Telegram –Ω–µ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω")
                    
                    created += 1
                else:
                    msg = f"LDAP add failed: {login}"
                    logging.error(msg)
                    print(f"‚ùå –æ—à–∏–±–∫–∞ LDAP")
                    errors += 1
            except Exception as e:
                logging.error(f"Error creating {login}: {e}")
                print(f"‚ùå {str(e)[:50]}")
                errors += 1
        else:
            print(f"‚è≠Ô∏è —É–∂–µ –µ—Å—Ç—å")
            updated += 1

    print("\n" + "=" * 70)
    print(f"‚úÖ –°–û–ó–î–ê–ù–û –í LDAP: {created}")
    print(f"üì± TELEGRAM (—Å–æ–∑–¥–∞–Ω–æ): {telegram_sent}")
    print(f"üóëÔ∏è  –£–î–ê–õ–ï–ù–û –ò–ó LDAP: {deleted}")
    print(f"üì± TELEGRAM (—É–¥–∞–ª–µ–Ω–æ): {telegram_deleted_sent}")
    print(f"‚è≠Ô∏è  –£–ñ–ï –ë–´–õ–û: {updated}")
    print(f"‚ùå –û–®–ò–ë–û–ö: {errors}")
    print(f"üìã –õ–æ–≥–∏: {LOG_FILE_PATH}")
    print("=" * 70)

    logging.info(f"Sync completed: created={created}, deleted={deleted}, telegram_new={telegram_sent}, telegram_del={telegram_deleted_sent}, updated={updated}, errors={errors}")

    ldap_conn.unbind()
    cnxn.close()
    print("üéâ –°–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞!\n")
    
    return True


# === –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ ===
if __name__ == "__main__":
    
    # === –õ–û–ì–ò–†–û–í–ê–ù–ò–ï (–æ–¥–∏–Ω —Ä–∞–∑ –ø—Ä–∏ —Å—Ç–∞—Ä—Ç–µ) ===
    logging.basicConfig(
        filename=LOG_FILE_PATH, 
        level=logging.INFO, 
        format='%(asctime)s - %(levelname)s - %(message)s',
        encoding='utf-8',
        filemode='a'
    )
    
    print("=" * 70)
    print("üöÄ RusGuard ‚ÜîÔ∏è LDAP + Telegram —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏—è")
    print("   ‚úÖ –°–æ–∑–¥–∞–Ω–∏–µ –∞–∫—Ç–∏–≤–Ω—ã—Ö")
    print("   üóëÔ∏è  –£–¥–∞–ª–µ–Ω–∏–µ –Ω–µ–∞–∫—Ç–∏–≤–Ω—ã—Ö")
    print(f"   –ê–≤—Ç–æ–∑–∞–ø—É—Å–∫: –∫–∞–∂–¥—ã–µ {SYNC_INTERVAL_SECONDS // 60} –º–∏–Ω—É—Ç")
    print("=" * 70)
    print("üõë –î–ª—è –æ—Å—Ç–∞–Ω–æ–≤–∫–∏: –∑–∞–∫—Ä—ã—Ç—å –æ–∫–Ω–æ –∏–ª–∏ Ctrl+C")
    print("=" * 70 + "\n")
    
    logging.info("=== APP STARTED (with deletion support) ===")
    
    cycle_count = 0
    
    try:
        while True:
            cycle_count += 1
            timestamp = datetime.now().strftime('%Y-%m-%d %H:%M:%S')
            
            print(f"\n{'='*70}")
            print(f"‚è∞ –¶–ò–ö–õ #{cycle_count} [{timestamp}]")
            print(f"{'='*70}\n")
            
            logging.info(f"Sync cycle #{cycle_count} started")
            
            do_sync()
            
            print(f"‚è≥ –û–∂–∏–¥–∞–Ω–∏–µ {SYNC_INTERVAL_SECONDS // 60} –º–∏–Ω—É—Ç –¥–æ —Å–ª–µ–¥—É—é—â–µ–π —Å–∏–Ω—Ö—Ä–æ–Ω–∏–∑–∞—Ü–∏–∏...")
            logging.info(f"Waiting {SYNC_INTERVAL_SECONDS} seconds...")
            
            time.sleep(SYNC_INTERVAL_SECONDS)
            
    except KeyboardInterrupt:
        print("\n\nüõë –û—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º (Ctrl+C)")
        logging.info("App stopped by user")
        sys.exit(0)
    except Exception as e:
        print(f"\n\n‚ùå –ö–†–ò–¢–ò–ß–ï–°–ö–ê–Ø –û–®–ò–ë–ö–ê: {e}")
        logging.error(f"Critical error: {e}")
        sys.exit(1)
